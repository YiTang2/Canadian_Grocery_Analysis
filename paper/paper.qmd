---
title: "My title"
subtitle: "My subtitle if needed"
author: 
  - Yi Tang
thanks: "Code and data are available at: https://github.com/YiTang2/Canadian_Grocery_Analysis.git "
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(palmerpenguins)
library(knitr)
library(arrow)
library(ggplot2)
library(dplyr)
library(here)
library(kableExtra)
library(gridExtra)
library(modelsummary)
library(rstanarm)
```


# Introduction

Overview paragraph

Estimand paragraph

Results paragraph

Why it matters paragraph

Telegraphing paragraph: The remainder of this paper is structured as follows. @sec-data....






# Data {#sec-data}

## Overview

Price of each month's coffee of different vendors data is provided by[@citedata]. This dataset records detailed sales about fast-moving consumer goods (FMCG) sold by various vendors, including volia, T&T, Loblaws, SaveOnFoods, Galleria, Metro, NoFrills and Walmart. It is also includes product-level details, such as the product name, current price, historical price (`old_price`), and the corresponding units and price per unit. The data also captures time-specific observations(2024-2-28 to 2024-6-22), with timestamps (nowtime) that can be used to analyze trends over days or months.

In order to simulate data, test simulated data, clean data, test cleaned data, exploratory data analysis and model data, we used R programming language [@citeR] to analyze the data and plot the graphs. Specific libraries that assisted the analysis include `tidyverse` [@citetidyverse], `palmerpenguins` [@palmerpenguins], `knitr` [@citeknitr], `arrow` [@citearrow], `ggplot2` [@citeggplot2],  `dplyr` [@citedplyr],  `here` [@citehere], `kableExtra` [@citekableExtra], `gridExtra`[@citegridExtra], `modelsummary`[@citemodelsummary], `rstanarm`[@citerstanarm].

The inspiration for my data processing came from my desire to study what factors would affect the current price of coffee products from two vendors in different regions of Canada, such as the current price of coffee products from two vendors, Metro and SaveOnFoods. The following variables are the data I selected after cleaning the data:

- `vendor`: The retailer selling the product in Canada.
- `old_price`: The historical price of the product, showing previous pricing or discounts.
- `product_name`: The specific product being sold, providing product-level insights.
- `current_price`: The price of the product at the time of observation.

New variable extracted and transformed from raw data:

- `month`: The month of data collection, extracted from `nowtime`.

Since the variable nowtime only records 4 months, it is considered a lack of Long-Term Trends, which means it's difficult to identify long-term pricing or demand patterns by using short data periods. So I only extracted a new variable—month from date of nowtime, which can simplify temporal analysis and identify trends, such as seasonal monthly pattern with price changes or demand patterns. It allows grouping data for monthly aggregation and supporting seasonality-focused insights or forecasting models.

To provide an preview of the coffee pricing with all potential factors that might affect it. Here, @tbl-sample-analysis-data simply reveals the variation between current price and old price in June for Metro's coffee products.

```{r}
#| label: tbl-sample-analysis-data
#| tbl-cap: "Sample of Analysis Data Showing Products Sold by Both Vendors"
#| echo: false
#| warning: false
#| message: false

# Load the analysis data
analysis_data <- read_parquet(here("data", "02-analysis_data", "analysis_data.parquet"))

# Select the first 10 rows
preview_table <- head(analysis_data, 10)

# Display the table
preview_table |>
  kable(
    col.names = colnames(preview_table),  # Use original column names
    digits = 2,  # Format numeric columns with 2 decimal places
    booktabs = TRUE,  # LaTeX-style formatting
    align = c("l", "l", "r", "r", "c"),  # Align columns (left, right, center)
    format.args = list(big.mark = ",")  # Add thousand separators to numbers
  ) |>
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

## Measurement

The dataset from Hammer represents real-world retail activities, capturing product details, vendor listings, and price updates. When vendors update product information, such as pricing or availability, Hammer collects and structures this information into the dataset.

Key fields include vendor, product name, current price, old price, and nowtime. The data is collected through scraping and structured to enable analysis of retail trends, pricing strategies, and market dynamics over time. Each entry serves as a snapshot of a product's presence in the market at a specific time, allowing for focused analyses, like tracking price trends for specific products (e.g., coffee).

## Data Visualization

```{r}
#| label: fig-Hist-of-current-price
#| fig-cap: "Histogram of Current Price"
#| message: false
#| echo: false

# First Graph
ggplot(analysis_data, aes(x = current_price)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black") +
  labs(x = "Current Price", y = "Frequency") +
  theme_minimal()
```

@fig-Hist-of-current-price shows a notable distribution with significant concentrations around 10 and 20 units. This suggests a pricing tier system where certain types of coffee products might be grouped by price points due to quality, brand, or other market factors. The dual peaks could indicate two main categories of coffee products, possibly differentiated by premium versus regular products.

```{r}
#| label: fig-Hist-of-old-price
#| fig-cap: "Histogram of Old Price"
#| message: false
#| echo: false

# Second Graph

ggplot(analysis_data, aes(x = old_price)) +
  geom_histogram(bins = 30, fill = "salmon", color = "black") +
  labs(x = "Old Price", y = "Frequency") +
  theme_minimal()

```

According to @fig-Hist-of-old-price, the distribution is mainly focused between 5 and 20 units, pointing to a past market strategy where products were clustered around these prices. The consistency in this price range might reflect a stable market before any recent pricing adjustments influenced by external factors like supplier changes or inflation.

```{r}
#| label: fig-Bar-plot-of-old-price
#| fig-cap: "Bar Plot of Old Price"
#| message: false
#| echo: false

# Third Graph

ggplot(analysis_data, aes(x = vendor, fill = vendor)) +
  geom_bar() +
  scale_fill_brewer(palette = "Pastel1") +
  labs(x = "Vendor", y = "Frequency") +
  theme_minimal()
```

In @fig-Bar-plot-of-old-price, the frequency of products available from Metro significantly surpasses that from SaveOnFoods, suggesting that Metro has a larger share of the market or a wider variety of coffee products. This dominance in product offerings could provide Metro with a competitive edge in attracting a broader customer base.

```{r}
#| label: fig-scatter-plot-of-current-vs-old-price
#| fig-cap: "Scatterplot of Current Price vs Old Price"
#| message: false
#| echo: false

# Fourth Graph

ggplot(analysis_data, aes(x = old_price, y = current_price)) +
  geom_point(aes(color = vendor), alpha = 0.6) +
  scale_color_manual(values = c("Metro" = "blue", "SaveOnFoods" = "red")) +
  labs(x = "Old Price", y = "Current Price") +
  theme_minimal()

```

The positive relationship shown in @fig-scatter-plot-of-current-vs-old-price here indicates that current prices are influenced by their historical prices, maintaining a proportional increase or decrease. This trend suggests a pricing policy that adjusts prices based on previous benchmarks while taking into account factors like cost adjustments or market demand.

```{r}
#| label: fig-barplot-of-old-price
#| fig-cap: "Boxplot of Current Price by Vendor"
#| message: false
#| echo: false


# Fifth Graph
ggplot(analysis_data, aes(x = vendor, y = current_price)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.3, width = 0.15, height = 0) +
  labs(
    x = "Vendor",
    y = "Current Price"
  ) +
  theme_minimal()

```

@fig-Bar-plot-of-old-price highlights how each vendor prices their products within the market. It shows that both vendors offer a wide range of prices, yet the spread and density of the data points may indicate Metro’s pricing strategy targets both lower and upper market segments, whereas SaveOnFoods might be focusing on a specific niche.

# Model {#sec-model} 

The goal of our Bayesian multiple linear regression is to investigate the factors that influence the current price of coffee in our dataset. Specifically, we try7  to understand how historical pricing, vendor differences, and seasonal monthly pattern affect current coffee prices.

## Model set-up

Define $y_i$ as the current price of coffee for the $i$-th observation in the dataset. The predictors include:

- $x_{1i}$, the old price of the coffee,
- $x_{2i}$, dummy variable for the vendor, where:\
$x_{2i}$ = 1: Vendor is "SaveOnFoods"; 
$x_{2i}$ = 0: Vendor is "Metro",
- $x_{3i}$, the numeric month variable.

The model is formulated as follows:

\begin{align} 
y_i|\mu_i, \sigma &\sim \mbox{Normal}(\mu_i, \sigma), \\
\mu_i &= \alpha + \beta_1 \cdot x_{1i} + \beta_2 \cdot x_{2i} + \beta_3 \cdot x_{3i}, \\
\alpha &\sim \mbox{Normal}(0, 2.5), \\
\beta_1 &\sim \mbox{Normal}(0, 2.5), \\ 
\beta_2 &\sim \mbox{Normal}(0, 2.5), \\
\beta_3 &\sim \mbox{Normal}(0, 2.5), \\
\sigma &\sim \mbox{Exponential}(1).
\end{align}


This model describes the relationship between the current price of coffee $\left(y_i\right)$ and three predictors: the old price of coffee $\left(x_{1 i}\right)$, a categorical vendor variable $\left(x_{2 i}\right)$ indicating whether the vendor is "Metro" or "SaveOnFoods," and a numeric variable for the month $\left(x_{3 i}\right)$. The response variable $\left(y_i\right)$ is modeled as normally distributed with mean $\mu_i$ and standard deviation $\sigma$. The mean $\mu_i$ is defined as a linear combination of these predictors, with coefficients $\beta_1, \beta_2$, and $\beta_3$, and an intercept $\alpha$. Prior distributions for the parameters are specified, including normal priors for $\alpha$ and the coefficients, and an exponential prior for $\sigma$. Intercept $\alpha$ represents the baseline mean current price for Metro if $x_{2i}$ = 1; otherwise when $x_{2i}$ = 0, it represents the mean current price for SaveOnFoods. Also, when old price and month is equal to 0, the intercept is not meaningful. Coefficient $\beta_1$ captures how changes in the old price affect the current price. Coefficient $\beta_2$ measures the difference in the mean coffee price between SaveOnFoods ($x_{2i}$ = 1) and Metro ($x_{2i}$ = 0). Coefficient $\beta_3$ reflects how the month influences current pricing, potentially capturing seasonal effects. 


To implement this Bayesian model, we use the `rstanarm` package [@citerstanarm] in `R` [@citeR].

### Model justification

The Bayesian Multiple Linear Regression (MLR) model is a suitable choice for analyzing the relationship between `current_price` (the dependent variable) and the predictors in the dataset. The dependent variable is continuous, and the Bayesian framework assumes a normal distribution for the response, which aligns well with the nature of coffee prices. This model captures the linear relationships between `old_price` (continuous), `vendor` (categorical, represented as a dummy variable), and `month` (numeric). These predictors are assumed to have additive effects on the response, which fits the linear regression framework. Logistic regression is used when the outcome variable is binary (e.g. 0 or 1). However, in our dataset, the dependent variable, `current_price`, is continuous. Since logistic regression cannot model continuous outcomes, it is unsuitable for this analysis. Also, poisson or negative binomial regression is typically applied when the response variable represents count data (e.g., the number of events occurring in a fixed period). `current_price` does not represent counts but rather continuous pricing data. Thus, these models do not align with the nature of the dependent variable.

## Model validation

@fig-ppcheck-and-posterior-vs-prior shows that our model accurately captures the central tendency of the data, though there are some deviations in the tail ends suggesting that the fit could be improved for extreme values. Additionally, the parameter estimation comparison chart highlights that most parameter estimates closely align with their priors, indicating a strong influence of prior settings on the estimates, especially under limited data. This is particularly evident with the vendorSaveOnFoods parameter, where its posterior distribution significantly diverges from others, hinting at potential anomalies in data sources or unique behaviors that warrant further investigation.

@fig-trace-plot illustrate that our Bayesian model parameters are converging and demonstrating stability, essential for robust statistical inference. The slight oscillation of the intercept around -0.5 indicates minor variability. Meanwhile, the old price coefficient shows remarkable consistency at approximately 0.77, underlining dependable estimates. The month parameter's minor fluctuations suggest a subtle yet consistent temporal effect. The vendorSaveOnFoods coefficient consistently remains near -0.6, indicating a persistently negative price influence compared to Metro. Finally, sigma's stability around 1.75 ensures the model's error variability is well-accounted for. These observations collectively affirm that the model's parameters are effectively calibrated, offering a reliable foundation for understanding the influences on coffee prices.

In @fig-rhat-plot analysis of coffee product pricing in Canada, the use of the $\hat{R}$ values to assess model convergence reveals that all parameters have $\hat{R}$ values below 1.05, indicating excellent convergence of the model. This result validates the reliability of our model in estimating coffee prices and ensures the robustness of the analysis outcomes. It allows us to trust the model outputs, providing a solid foundation for further strategic decision-making and market analysis.


# Results {#sec-results}

@tbl-model-summary indicates a robust fit with a high $R^2$ of 0.900, suggesting a strong explanatory power of the model regarding the variance in coffee product prices. The model's parameters show that the old price of coffee (coefficient = 0.77) has a significant positive influence on the current price, suggesting that past pricing trends are good predictors of current pricing strategies. Vendor impact, specifically SaveOnFoods, shows a negative association with current price (coefficient = -0.61), indicating that coffee products from SaveOnFoods tend to be cheaper compared to Metro. Additionally, the month coefficient (0.06) implies a slight monthly variation in coffee pricing. The model's predictive performance is validated by low WAIC and LOOIC scores, and a small RMSE of 1.75, enhancing confidence in the reliability of its predictions.

@fig-credibility-interval llustrates the posterior distributions for the parameters in your Bayesian regression model, analyzing factors influencing coffee prices. The intercept shows a slight positive baseline effect. The old price of coffee strongly and positively affects the current price, indicating a direct relationship. The month variable shows a minimal and variable impact. SaveOnFoods, as a vendor, is associated with lower prices compared to Metro. The sigma parameter, indicating the model's error variance, shows a sharp and precise estimation, suggesting consistent variability in the data explained by the model.



# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

Please don't use these as sub-heading labels - change them to be what your point actually is.

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}

# Model details
```{r}
#| eval: true
#| echo: false
#| message: false
#| warning: false
#| label: fig-ppcheck-and-posterior-vs-prior
#| layout-ncol: 2
#| fig-cap: "PPcheck & Posterior vs Prior"
#| fig-subcap: ["Posterior prediction check", "Comparing the posterior with the prior"]

Coffee_product_pricing <-
  readRDS(file = here::here("models/Coffee_product_pricing.rds"))

pp_check(Coffee_product_pricing) +
  theme_classic() +
  theme(legend.position = "bottom")

posterior_vs_prior(Coffee_product_pricing) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") +
  theme(legend.position = "bottom") +
  coord_flip()
```

```{r}
#| label: tbl-model-summary
#| tbl-cap: "Model summary of Coffee product pricing"
#| eval: true
#| echo: false
#| warning: false
#| message: false

# Generate model summary table
modelsummary(
  list(
    "Coffee product pricing" = Coffee_product_pricing
  ),
  fmt = 2
)

```


```{r}
#| label: fig-credibility-interval
#| fig-cap: "credibility interval"
#| eval: true
#| echo: false
#| warning: false
#| message: false

plot(
  Coffee_product_pricing,
  "areas"
)
```

```{r}
#| label: fig-trace-plot
#| fig-cap: "Trace plot"
#| eval: true
#| echo: false
#| warning: false
#| message: false

plot(Coffee_product_pricing, "trace")

```

```{r}
#| label: fig-rhat-plot
#| fig-cap: "R-hat plot"
#| eval: true
#| echo: false
#| warning: false
#| message: false

plot(Coffee_product_pricing, "rhat")
```

\newpage


# References


